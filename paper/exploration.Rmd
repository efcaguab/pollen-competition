---
title: "The degree/benefit trade-off: deposition data"
author: "Fernando Cagua"
date: "4 April 2017"
output: 
  html_notebook: 
    code_folding: hide
    fig_caption: yes
---

```{r setup, message=FALSE, results='hide'}
library(dplyr)
library(ggplot2)
library(ape)
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE,
                      fig.width = 8, 
                      fig.height = 6)

# read data
dep <- readRDS("../data/datasets/processed/all_deposition.rds")
dep_df <- plyr::ldply(dep, function(x){
  x$deposition %>%
    mutate(site = x$name, 
           study = x$study)
}) %>%
  mutate(pollen_category = recipient == donor,
         pollen_category = if_else(pollen_category, 
                                   "conspecific", 
                                   "heterospecific"),
         grain_density = n_grains/n_stigma)

deg <- readRDS("../data/datasets/processed/all_degree.rds")
deg_df <- plyr::ldply(deg, function(x){
  x$degree %>%
    mutate(study = x$study)
})
phylo <- readRDS("../data/datasets/processed/all_phylogeny.rds")
```

This is a preliminary analysis using Hugo's and Emer data. Here, species degree is independently calculated from a visitation network. 

In Hugo's data control flowers  were used to account for the effect of self pollination. The treatment "closed" corresponds to when flowers were bagged, and the treatment "open" allowed for insects to come and pollinate the flower. 

The follwing graph shows the number of grains as a function of the overall plant degree (the number of distinct partners across all sites) for both the open and closed treatment. Some jitter was added to the x axis to facilitate visualisation. 

```{r}

inner_join(deg_df, dep_df, by = c("plant_name" = "recipient", "study")) %>% 
  filter(!is.na(pollen_category)) %>%
  ggplot(aes(x = degree, y = grain_density + 1)) + 
  geom_point(aes(colour = pollen_category),
             position = position_jitter(0.01),
             size = 1, 
             alpha = 0.7) +
  geom_smooth(aes(colour = pollen_category),
              method = "lm") +
  facet_grid(study~treatment) +
  scale_y_log10() +
  scale_x_log10() +
  theme(legend.position = "top") +
  ggtitle("Degree vs pollen count per stigma", "Overall degree")

# inner_join(degree_overall, dep_df) %>% 
```

Now looking at the proportion:

```{r}
cons_prop <- inner_join(deg_df, dep_df, by = c("plant_name" = "recipient", "study")) %>% 
  group_by(study, plant) %>%
  arrange(pollen_category) %>% 
  summarise(conspecific = first(grain_density),
            heterospecific = last(grain_density),
            cons_prop = conspecific/(conspecific + heterospecific),
            cons_log_dif = log(conspecific + 1) - log(heterospecific + 1))

dep_df %>%
  select(treatment, site, study, recipient, plant) %>%
  distinct() %>% 
  inner_join(cons_prop) %>% 
  inner_join(deg_df, by = c("recipient" = "plant_name", "study")) %>% 
  ggplot(aes(x = degree, y = cons_prop)) + 
  geom_point(aes(colour = recipient), 
             position = position_jitter(0.3),
             size = 1, 
             alpha = 0.7) +
  geom_smooth(method = "glm", color = "black", method.args = list(family = "binomial")) +
  facet_grid(study~treatment) +
  theme(legend.position = "none") +
  ggtitle("Degree vs conspecific/heterospecific proportion", "Site level degree")

dep_df %>%
  select(treatment, site, study, recipient, plant) %>%
  distinct() %>% 
  inner_join(cons_prop) %>% 
  inner_join(deg_df, by = c("recipient" = "plant_name", "study")) %>% 
  ggplot(aes(x = degree, y = cons_log_dif)) + 
  geom_point(aes(colour = recipient), 
             position = position_jitter(0.3),
             size = 1, 
             alpha = 0.7) +
  geom_smooth(method = "lm", color = "black", method.args = list(family = "gaussian")) +
  facet_grid(study~treatment) +
  theme(legend.position = "none") +
  ggtitle("Degree vs conspecific/heterospecific log-difference", "Site level degree")
```

## Phylogenies

A quick & dirty phylogeny from phylomatic using the subset of species is shown here. To future versions a dated phylogeny based on sequence data will be generated.

```{r}
phylo_plants <- phylo$tip.label
study_plants <- inner_join(deg_df, 
                           dep_df, 
                           by = c("plant_name" = "recipient", "study")) %$%
  plant_name %>%
  unique() %>% 
  tolower() %>% 
  gsub(" ", "_", .)

trim_phylo <- drop.tip(phylo,phylo_plants[!phylo_plants %in% study_plants])
plot(trim_phylo)
```

We check wether degree is phylogenetically conserved once we have branch lengths. 

```{r, eval = F}
deg_df %>%
  mutate(plant_name_phylo = tolower(plant_name), 
         plant_name_phylo = gsub(" ", "_", plant_name_phylo)) %>%
  right_join(data.frame(plant_name_phylo = trim_phylo$tip.label)) %>%
  group_by(plant_name_phylo) %>%
  summarise(degree = mean(degree)) %$%
  degree %>% log() %>%
  phytools::phylosig(trim_phylo, .)
```


Re weight degree -> 
* Quality pollinator based on what they carry
* Plant phenology (temporal overlap)
* Strengt:degree
* MCMCglmm
